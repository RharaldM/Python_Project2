{% extends 'base.html' %}
{% block title %}Painel{% endblock %}
{% block content %}
<h2 class="mb-4">Olá, {{ user.username if user else "usuário" }}!</h2>

<!-- BOTÕES DE EXPORTAÇÃO -->
<div class="mb-3 d-flex gap-2">
    <a href="{{ url_for('export_pdf') }}" class="btn btn-outline-secondary">Exportar PDF</a>
    <a href="{{ url_for('export_excel') }}" class="btn btn-outline-secondary">Exportar Excel</a>
</div>

<div class="card mb-4 shadow-sm">
    <div class="card-header bg-primary text-white">
        <h3 class="h5 mb-0">Estatísticas de Tarefas</h3>
    </div>
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-4">
                <div class="card text-center h-100">
                    <div class="card-body">
                        <h5 class="card-title">Total de Tarefas</h5>
                        <p class="card-text display-6">{{ total_tasks }}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-center h-100">
                    <div class="card-body">
                        <h5 class="card-title">Tarefas Concluídas</h5>
                        <p class="card-text display-6 text-success">{{ completed_tasks }}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-center h-100">
                    <div class="card-body">
                        <h5 class="card-title">Tarefas Pendentes</h5>
                        <p class="card-text display-6 text-warning">{{ pending_tasks }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-info text-white">
                <h3 class="h5 mb-0">Progresso Geral</h3>
            </div>
            <div class="card-body d-flex justify-content-center align-items-center">
                <canvas id="progressChart" style="max-height: 250px;"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-success text-white">
                <h3 class="h5 mb-0">Tarefas por Prioridade</h3>
            </div>
            <div class="card-body d-flex justify-content-center align-items-center">
                <canvas id="priorityChart" style="max-height: 250px;"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="card mb-4 shadow-sm">
    <div class="card-header bg-dark text-white">
        <h3 class="h5 mb-0">Minhas Tarefas</h3>
    </div>
    <div class="card-body">
        <div class="mb-3">
            <a href="{{ url_for('add_task') }}" class="btn btn-primary">Adicionar Nova Tarefa</a>
        </div>

        <form method="get" action="{{ url_for('dashboard') }}" class="mb-4">
            <div class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label for="filter_priority" class="form-label">Prioridade:</label>
                    <select class="form-select" id="filter_priority" name="priority">
                        <option value="all" {% if not filter_priority or filter_priority == 'all' %}selected{% endif %}>Todas</option>
                        <option value="high" {% if filter_priority == 'high' %}selected{% endif %}>Alta</option>
                        <option value="medium" {% if filter_priority == 'medium' %}selected{% endif %}>Média</option>
                        <option value="low" {% if filter_priority == 'low' %}selected{% endif %}>Baixa</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="filter_category" class="form-label">Categoria:</label>
                    <select class="form-select" id="filter_category" name="category">
                        <option value="all" {% if not filter_category or filter_category == 'all' %}selected{% endif %}>Todas</option>
                        {% for category in all_categories %}
                            <option value="{{ category.name }}" {% if filter_category == category.name %}selected{% endif %}>{{ category.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="filter_status" class="form-label">Status:</label>
                    <select class="form-select" id="filter_status" name="status">
                        <option value="all" {% if not filter_status or filter_status == 'all' %}selected{% endif %}>Todos</option>
                        <option value="pending" {% if filter_status == 'pending' %}selected{% endif %}>Pendentes</option>
                        <option value="completed" {% if filter_status == 'completed' %}selected{% endif %}>Concluídas</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="filter_due_date" class="form-label">Data de Vencimento (até):</label>
                    <input type="date" class="form-control" id="filter_due_date" name="due_date" value="{{ filter_due_date }}">
                </div>
                <div class="col-12 d-flex justify-content-end">
                    <button type="submit" class="btn btn-info me-2">Aplicar Filtros</button>
                    <a href="{{ url_for('dashboard') }}" class="btn btn-warning">Limpar Filtros</a>
                </div>
            </div>
        </form>

        {% if tasks %}
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead>
                        <tr>
                            <th scope="col">Título</th>
                            <th scope="col">Prioridade</th>
                            <th scope="col">Categorias</th>
                            <th scope="col">Vencimento</th>
                            <th scope="col">Status</th>
                            <th scope="col">Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for task in tasks %}
                        <tr class="
                            {% if task.completed %}table-success{% else %}
                                {% if task.due_date and task.due_date < now and not task.completed %} border-danger border-2
                                {% elif task.due_date and (task.due_date - now).days <= 2 and not task.completed %} table-warning
                                {% endif %}
                            {% endif %}
                        ">
                            <td class="{{ 'text-decoration-line-through' if task.completed }}">
                                {{ task.title }}
                            </td>
                            <td>
                                {% if task.priority == 'high' %}
                                    <span class="badge text-bg-danger">Alta</span>
                                {% elif task.priority == 'medium' %}
                                    <span class="badge text-bg-warning">Média</span>
                                {% else %}
                                    <span class="badge text-bg-info">Baixa</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if task.categories %}
                                    {% for category in task.categories %}
                                        <span class="badge text-bg-secondary me-1">{{ category.name }}</span>
                                    {% endfor %}
                                {% else %}
                                    <span class="text-muted">N/A</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if task.due_date %}
                                    {{ task.due_date.strftime('%d/%m/%Y') }}
                                    {% if not task.completed and task.due_date < now %}
                                        <span class="badge text-bg-danger ms-1">Atrasada!</span>
                                    {% endif %}
                                {% else %}
                                    N/A
                                {% endif %}
                            </td>
                            <td>
                                {% if task.completed %}
                                    <span class="badge text-bg-success">Concluída</span>
                                {% else %}
                                    <span class="badge text-bg-warning">Pendente</span>
                                {% endif %}
                            </td>
                            <td>
                                <a href="{{ url_for('edit_task', task_id=task.id) }}" class="btn btn-sm btn-outline-primary me-1" data-bs-toggle="tooltip" data-bs-placement="top" title="Editar">
                                    <i class="bi bi-pencil"></i>
                                </a>
                                <form action="{{ url_for('complete_task', task_id=task.id) }}" method="post" class="d-inline">
                                    <button type="submit" class="btn btn-sm {% if task.completed %}btn-outline-warning{% else %}btn-outline-success{% endif %} me-1" data-bs-toggle="tooltip" data-bs-placement="top" title="{% if task.completed %}Desfazer{% else %}Concluir{% endif %}">
                                        <i class="bi {% if task.completed %}bi-arrow-counterclockwise{% else %}bi-check-lg{% endif %}"></i>
                                    </button>
                                </form>
                                <form action="{{ url_for('delete_task', task_id=task.id) }}" method="post" class="d-inline" onsubmit="return confirm('Tem certeza que deseja excluir esta tarefa?');">
                                    <button type="submit" class="btn btn-sm btn-outline-danger" data-bs-toggle="tooltip" data-bs-placement="top" title="Excluir">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <p class="text-center text-muted">Nenhuma tarefa encontrada.</p>
        {% endif %}
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-primary text-white">
                <h3 class="h5 mb-0">Tarefas por Categoria</h3>
            </div>
            <div class="card-body d-flex justify-content-center align-items-center">
                <canvas id="categoryChart" style="max-height: 250px;"></canvas>
            </div>
        </div>
    </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Gráfico de Progresso Geral
    const progressCtx = document.getElementById('progressChart').getContext('2d');
    new Chart(progressCtx, {
        type: 'pie',
        data: {
            labels: ['Concluídas', 'Pendentes'],
            datasets: [{
                data: [{{ completed_tasks | default(0) }}, {{ pending_tasks | default(0) }}],
                backgroundColor: ['#28a745', '#ffc107'],
                borderColor: ['#ffffff', '#ffffff'],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.label || '';
                            let value = context.parsed || 0;
                            let total = context.dataset.data.reduce((a, b) => a + b, 0);
                            let percentage = total ? ((value / total) * 100).toFixed(1) : 0;
                            return `${label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });

    // Gráfico de Prioridade
    const priorityCtx = document.getElementById('priorityChart').getContext('2d');
    new Chart(priorityCtx, {
        type: 'bar',
        data: {
            labels: {{ priority_labels | tojson }}, // Dados do Python
            datasets: [{
                label: 'Número de Tarefas',
                data: {{ priority_data | tojson }}, // Dados do Python
                backgroundColor: [
                    'rgba(220, 53, 69, 0.7)', // Danger (High)
                    'rgba(255, 193, 7, 0.7)',  // Warning (Medium)
                    'rgba(23, 162, 184, 0.7)'  // Info (Low)
                ],
                borderColor: [
                    'rgba(220, 53, 69, 1)',
                    'rgba(255, 193, 7, 1)',
                    'rgba(23, 162, 184, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false // Não precisa de legenda para uma única barra
                },
                title: {
                    display: true,
                    text: 'Tarefas por Prioridade'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        precision: 0 // Garante que os ticks sejam números inteiros
                    }
                }
            }
        }
    });

    // Gráfico de Categorias (Pie Chart)
    const categoryCtx = document.getElementById('categoryChart').getContext('2d');
    const categoryLabels = {{ category_data | map(attribute=0) | list | tojson }}; // Nomes das categorias
    const categoryCounts = {{ category_data | map(attribute=1) | list | tojson }}; // Contagens das categorias

    // Gerar cores dinamicamente para as categorias
    function generateColors(numColors) {
        const colors = [];
        for (let i = 0; i < numColors; i++) {
            const hue = (i * 137.508) % 360; // Golden angle approximation
            colors.push(`hsl(${hue}, 70%, 60%)`); // Saturação e luminosidade fixas
        }
        return colors;
    }
    const backgroundColors = generateColors(categoryLabels.length);

    new Chart(categoryCtx, {
        type: 'pie',
        data: {
            labels: categoryLabels,
            datasets: [{
                data: categoryCounts,
                backgroundColor: backgroundColors,
                hoverOffset: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                },
                title: {
                    display: true,
                    text: 'Tarefas por Categoria'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.label || '';
                            let value = context.parsed || 0;
                            let total = context.dataset.data.reduce((a, b) => a + b, 0);
                            let percentage = total ? ((value / total) * 100).toFixed(1) : 0;
                            return `${label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
});
</script>

{% endblock %}