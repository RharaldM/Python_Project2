{% extends 'base.html' %}
{% block title %}Painel{% endblock %}
{% block content %}
<h2 class="mb-4">Olá, {{ user.username if user else "usuário" }}!</h2>

<!-- BOTÕES DE EXPORTAÇÃO -->
<div class="mb-3 d-flex gap-2">
    <a href="{{ url_for('export_pdf') }}" class="btn btn-outline-secondary">Exportar PDF</a>
    <a href="{{ url_for('export_excel') }}" class="btn btn-outline-secondary">Exportar Excel</a>
</div>

<div class="card mb-4 shadow-sm">
    <div class="card-header bg-primary text-white">
        <h3 class="h5 mb-0">Estatísticas de Tarefas</h3>
    </div>
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-4">
                <div class="card text-center h-100">
                    <div class="card-body">
                        <h5 class="card-title">Total de Tarefas</h5>
                        <p class="card-text display-6">{{ total_tasks }}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-center h-100">
                    <div class="card-body">
                        <h5 class="card-title">Tarefas Concluídas</h5>
                        <p class="card-text display-6 text-success">{{ completed_tasks }}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-center h-100">
                    <div class="card-body">
                        <h5 class="card-title">Tarefas Pendentes</h5>
                        <p class="card-text display-6 text-warning">{{ pending_tasks }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- NOVOS GRÁFICOS DETALHADOS -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-secondary text-white">
                <h3 class="h5 mb-0">Tarefas criadas por mês</h3>
            </div>
            <div class="card-body d-flex justify-content-center align-items-center">
                <canvas id="tasksPerMonthChart" style="max-height: 250px;"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-secondary text-white">
                <h3 class="h5 mb-0">Progresso dos Checklists</h3>
            </div>
            <div class="card-body d-flex justify-content-center align-items-center">
                <canvas id="subtasksProgressChart" style="max-height: 250px;"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-info text-white">
                <h3 class="h5 mb-0">Progresso Geral</h3>
            </div>
            <div class="card-body d-flex justify-content-center align-items-center">
                <canvas id="progressChart" style="max-height: 250px;"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-success text-white">
                <h3 class="h5 mb-0">Tarefas por Prioridade</h3>
            </div>
            <div class="card-body d-flex justify-content-center align-items-center">
                <canvas id="priorityChart" style="max-height: 250px;"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="card mb-4 shadow-sm">
    <div class="card-header bg-dark text-white">
        <h3 class="h5 mb-0">Minhas Tarefas</h3>
    </div>
    <div class="card-body">
        <div class="mb-3">
            <a href="{{ url_for('add_task') }}" class="btn btn-primary">Adicionar Nova Tarefa</a>
        </div>

        <form method="get" action="{{ url_for('dashboard') }}" class="mb-4">
            <div class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label for="filter_priority" class="form-label">Prioridade:</label>
                    <select class="form-select" id="filter_priority" name="priority">
                        <option value="all" {% if not filter_priority or filter_priority == 'all' %}selected{% endif %}>Todas</option>
                        <option value="high" {% if filter_priority == 'high' %}selected{% endif %}>Alta</option>
                        <option value="medium" {% if filter_priority == 'medium' %}selected{% endif %}>Média</option>
                        <option value="low" {% if filter_priority == 'low' %}selected{% endif %}>Baixa</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="filter_category" class="form-label">Categoria:</label>
                    <select class="form-select" id="filter_category" name="category">
                        <option value="all" {% if not filter_category or filter_category == 'all' %}selected{% endif %}>Todas</option>
                        {% for category in all_categories %}
                            <option value="{{ category.name }}" {% if filter_category == category.name %}selected{% endif %}>{{ category.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="filter_status" class="form-label">Status:</label>
                    <select class="form-select" id="filter_status" name="status">
                        <option value="all" {% if not filter_status or filter_status == 'all' %}selected{% endif %}>Todos</option>
                        <option value="pending" {% if filter_status == 'pending' %}selected{% endif %}>Pendentes</option>
                        <option value="completed" {% if filter_status == 'completed' %}selected{% endif %}>Concluídas</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="filter_due_date" class="form-label">Data de Vencimento (até):</label>
                    <input type="date" class="form-control" id="filter_due_date" name="due_date" value="{{ filter_due_date }}">
                </div>
                <div class="col-12 d-flex justify-content-end">
                    <button type="submit" class="btn btn-info me-2">Aplicar Filtros</button>
                    <a href="{{ url_for('dashboard') }}" class="btn btn-warning">Limpar Filtros</a>
                </div>
            </div>
        </form>

        {% if tasks %}
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead>
                        <tr>
                            <th scope="col">Título</th>
                            <th scope="col">Prioridade</th>
                            <th scope="col">Categorias</th>
                            <th scope="col">Vencimento</th>
                            <th scope="col">Status</th>
                            <th scope="col">Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for task in tasks %}
                        <tr class="
                            {% if task.completed %}table-success{% else %}
                                {% if task.due_date and task.due_date < now and not task.completed %} border-danger border-2
                                {% elif task.due_date and (task.due_date - now).days <= 2 and not task.completed %} table-warning
                                {% endif %}
                            {% endif %}
                        ">
                            <td class="{{ 'text-decoration-line-through' if task.completed }}">
                                {{ task.title }}
                                {% if task.subtasks %}
                                    <ul class="list-group mt-2">
                                    {% for sub in task.subtasks %}
                                        <li class="list-group-item py-1">
                                            <form method="post" action="{{ url_for('toggle_subtask', subtask_id=sub.id) }}" style="display:inline;">
                                                <input type="checkbox" name="completed" onchange="this.form.submit()" {% if sub.completed %}checked{% endif %} />
                                            </form>
                                            <span class="{% if sub.completed %}text-decoration-line-through text-success{% endif %}">
                                                {{ sub.description }}
                                            </span>
                                        </li>
                                    {% endfor %}
                                    </ul>
                                {% endif %}
                            </td>
                            <td>
                                {% if task.priority.value == 'high' %}
                                    <span class="badge text-bg-danger">Alta</span>
                                {% elif task.priority.value == 'medium' %}
                                    <span class="badge text-bg-warning">Média</span>
                                {% else %}
                                    <span class="badge text-bg-info">Baixa</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if task.categories %}
                                    {% for category in task.categories %}
                                        <span class="badge text-bg-secondary me-1">{{ category.name }}</span>
                                    {% endfor %}
                                {% else %}
                                    <span class="text-muted">N/A</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if task.due_date %}
                                    {{ task.due_date.strftime('%d/%m/%Y') }}
                                    {% if not task.completed and task.due_date < now %}
                                        <span class="badge text-bg-danger ms-1">Atrasada!</span>
                                    {% endif %}
                                {% else %}
                                    N/A
                                {% endif %}
                            </td>
                            <td>
                                {% if task.completed %}
                                    <span class="badge text-bg-success">Concluída</span>
                                {% else %}
                                    <span class="badge text-bg-warning">Pendente</span>
                                {% endif %}
                            </td>
                            <td>
                                <a href="{{ url_for('edit_task', task_id=task.id) }}" class="btn btn-sm btn-outline-primary me-1" data-bs-toggle="tooltip" data-bs-placement="top" title="Editar">
                                    <i class="bi bi-pencil"></i>
                                </a>
                                <form action="{{ url_for('complete_task', task_id=task.id) }}" method="post" class="d-inline">
                                    <button type="submit" class="btn btn-sm {% if task.completed %}btn-outline-warning{% else %}btn-outline-success{% endif %} me-1" data-bs-toggle="tooltip" data-bs-placement="top" title="{% if task.completed %}Desfazer{% else %}Concluir{% endif %}">
                                        <i class="bi {% if task.completed %}bi-arrow-counterclockwise{% else %}bi-check-lg{% endif %}"></i>
                                    </button>
                                </form>
                                <form action="{{ url_for('delete_task', task_id=task.id) }}" method="post" class="d-inline" onsubmit="return confirm('Tem certeza que deseja excluir esta tarefa?');">
                                    <button type="submit" class="btn btn-sm btn-outline-danger" data-bs-toggle="tooltip" data-bs-placement="top" title="Excluir">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <p class="text-center text-muted">Nenhuma tarefa encontrada.</p>
        {% endif %}
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-primary text-white">
                <h3 class="h5 mb-0">Tarefas por Categoria</h3>
            </div>
            <div class="card-body d-flex justify-content-center align-items-center">
                <canvas id="categoryChart" style="max-height: 250px;"></canvas>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
function getThemeColors() {
    const theme = document.body.getAttribute('data-bs-theme') || 'light';
    if (theme === 'dark') {
        return {
            bg: ['#198754', '#ffc107', '#0dcaf0', '#6c757d', '#dc3545', '#212529'],
            font: '#fff',
            grid: '#343a40'
        };
    } else {
        return {
            bg: ['#28a745', '#ffc107', '#17a2b8', '#adb5bd', '#dc3545', '#f8f9fa'],
            font: '#212529',
            grid: '#dee2e6'
        };
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // Gráfico de Progresso Geral
    const progressCtx = document.getElementById('progressChart').getContext('2d');
    const progressChart = new Chart(progressCtx, {
        type: 'pie',
        data: {
            labels: ['Concluídas', 'Pendentes'],
            datasets: [{
                data: [{{ completed_tasks | default(0) }}, {{ pending_tasks | default(0) }}],
                backgroundColor: [getThemeColors().bg[0], getThemeColors().bg[1]],
                borderColor: ['#ffffff', '#ffffff'],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom', labels: { color: getThemeColors().font } },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.label || '';
                            let value = context.parsed || 0;
                            let total = context.dataset.data.reduce((a, b) => a + b, 0);
                            let percentage = total ? ((value / total) * 100).toFixed(1) : 0;
                            return `${label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });

    // Gráfico de Prioridade
    const priorityCtx = document.getElementById('priorityChart').getContext('2d');
    const priorityChart = new Chart(priorityCtx, {
        type: 'bar',
        data: {
            labels: {{ priority_labels | tojson }},
            datasets: [{
                label: 'Número de Tarefas',
                data: {{ priority_data | tojson }},
                backgroundColor: [
                    getThemeColors().bg[0],
                    getThemeColors().bg[1],
                    getThemeColors().bg[2]
                ],
                borderColor: [
                    getThemeColors().bg[0],
                    getThemeColors().bg[1],
                    getThemeColors().bg[2]
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false, labels: { color: getThemeColors().font } },
                title: { display: true, text: 'Tarefas por Prioridade', color: getThemeColors().font }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { precision: 0, color: getThemeColors().font },
                    grid: { color: getThemeColors().grid }
                },
                x: {
                    ticks: { color: getThemeColors().font },
                    grid: { color: getThemeColors().grid }
                }
            }
        }
    });

    // Gráfico de Categorias (Pie Chart)
    const categoryCtx = document.getElementById('categoryChart').getContext('2d');
    const categoryLabels = {{ category_data | map(attribute=0) | list | tojson }};
    const categoryCounts = {{ category_data | map(attribute=1) | list | tojson }};
    function generateColors(numColors) {
        const colors = [];
        for (let i = 0; i < numColors; i++) {
            const hue = (i * 137.508) % 360;
            colors.push(`hsl(${hue}, 70%, 60%)`);
        }
        return colors;
    }
    const backgroundColors = generateColors(categoryLabels.length);
    const categoryChart = new Chart(categoryCtx, {
        type: 'pie',
        data: {
            labels: categoryLabels,
            datasets: [{
                data: categoryCounts,
                backgroundColor: backgroundColors,
                hoverOffset: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom', labels: { color: getThemeColors().font } },
                title: { display: true, text: 'Tarefas por Categoria', color: getThemeColors().font },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.label || '';
                            let value = context.parsed || 0;
                            let total = context.dataset.data.reduce((a, b) => a + b, 0);
                            let percentage = total ? ((value / total) * 100).toFixed(1) : 0;
                            return `${label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });

    // Gráfico de tarefas por mês
    const tasksPerMonthCtx = document.getElementById('tasksPerMonthChart').getContext('2d');
    const tasksPerMonthChart = new Chart(tasksPerMonthCtx, {
        type: 'line',
        data: {
            labels: {{ tasks_per_month_labels | tojson }},
            datasets: [{
                label: 'Tarefas criadas',
                data: {{ tasks_per_month_data | tojson }},
                fill: true,
                borderColor: getThemeColors().bg[0],
                backgroundColor: getThemeColors().bg[0] + '33',
                pointBackgroundColor: getThemeColors().bg[0]
            }]
        },
        options: {
            plugins: { legend: { labels: { color: getThemeColors().font } } },
            scales: {
                x: { ticks: { color: getThemeColors().font }, grid: { color: getThemeColors().grid } },
                y: { beginAtZero: true, ticks: { color: getThemeColors().font }, grid: { color: getThemeColors().grid } }
            }
        }
    });

    // Gráfico de progresso dos checklists
    const subtasksProgressCtx = document.getElementById('subtasksProgressChart').getContext('2d');
    const subtasksProgressChart = new Chart(subtasksProgressCtx, {
        type: 'doughnut',
        data: {
            labels: ['Concluídas', 'Pendentes'],
            datasets: [{
                data: [{{ completed_subtasks|default(0) }}, {{ pending_subtasks|default(0) }}],
                backgroundColor: [getThemeColors().bg[0], getThemeColors().bg[1]],
                borderWidth: 2
            }]
        },
        options: {
            plugins: { legend: { position: 'bottom', labels: { color: getThemeColors().font } } }
        }
    });

    // Atualiza as cores dos gráficos ao alternar tema
    document.getElementById('toggle-theme').addEventListener('click', function() {
        setTimeout(() => {
            // Progresso geral
            progressChart.data.datasets[0].backgroundColor = [getThemeColors().bg[0], getThemeColors().bg[1]];
            progressChart.options.plugins.legend.labels.color = getThemeColors().font;
            progressChart.update();

            // Prioridade
            priorityChart.data.datasets[0].backgroundColor = [
                getThemeColors().bg[0], getThemeColors().bg[1], getThemeColors().bg[2]
            ];
            priorityChart.data.datasets[0].borderColor = [
                getThemeColors().bg[0], getThemeColors().bg[1], getThemeColors().bg[2]
            ];
            priorityChart.options.plugins.legend.labels.color = getThemeColors().font;
            priorityChart.options.plugins.title.color = getThemeColors().font;
            priorityChart.options.scales.x.ticks.color = getThemeColors().font;
            priorityChart.options.scales.y.ticks.color = getThemeColors().font;
            priorityChart.options.scales.x.grid.color = getThemeColors().grid;
            priorityChart.options.scales.y.grid.color = getThemeColors().grid;
            priorityChart.update();

            // Categoria
            categoryChart.options.plugins.legend.labels.color = getThemeColors().font;
            categoryChart.options.plugins.title.color = getThemeColors().font;
            categoryChart.update();

            // Tarefas por mês
            tasksPerMonthChart.data.datasets[0].borderColor = getThemeColors().bg[0];
            tasksPerMonthChart.data.datasets[0].backgroundColor = getThemeColors().bg[0] + '33';
            tasksPerMonthChart.options.plugins.legend.labels.color = getThemeColors().font;
            tasksPerMonthChart.options.scales.x.ticks.color = getThemeColors().font;
            tasksPerMonthChart.options.scales.x.grid.color = getThemeColors().grid;
            tasksPerMonthChart.options.scales.y.ticks.color = getThemeColors().font;
            tasksPerMonthChart.options.scales.y.grid.color = getThemeColors().grid;
            tasksPerMonthChart.update();

            // Subtarefas progresso
            subtasksProgressChart.data.datasets[0].backgroundColor = [getThemeColors().bg[0], getThemeColors().bg[1]];
            subtasksProgressChart.options.plugins.legend.labels.color = getThemeColors().font;
            subtasksProgressChart.update();
        }, 200);
    });
});
</script>
{% endblock %}